KISSY.Editor.add("image",function(p){var h=KISSY.Editor,i=KISSY,s=i.UA,q=i.Node,t=i.Event,r=h.BubbleView,u=h.SimpleOverlay;h.ImageInserter||function(){function l(a){l.superclass.constructor.call(this,a);this._init()}var m=function(a){return a._4e_name()==="img"&&!/(^|\s+)ke_/.test(a[0].className)&&a},v=h.TripleButton,w="<div><p><label><span style='color:#0066CC;font-weight:bold;'>\u56fe\u7247\u7f51\u5740\uff1a </span><input class='ke-img-url' style='width:230px' value='http://'/></label></p><p style='margin:5px 0'><label><span style='color:#0066CC;font-weight:bold;'>\u9ad8\u5ea6\uff1a </span><input class='ke-img-height' style='width:90px' value='\u81ea\u52a8'/> px </label> &nbsp;<label><span style='color:#0066CC;font-weight:bold;'>\u5bbd\u5ea6\uff1a </span><input class='ke-img-width' style='width:90px' value='\u81ea\u52a8'/> px </label></p><p><label><span style='color:#0066CC;font-weight:bold;'>\u5bf9\u9f50\uff1a </span><select class='ke-img-align'><option value=''>\u65e0</option><option value='left'>\u5de6\u5bf9\u9f50</option><option value='right'>\u53f3\u5bf9\u9f50</option></select>"+
h.Utils.duplicateStr("&nbsp;",13)+"<label><span style='color:#0066CC;font-weight:bold;'>\u95f4\u8ddd\uff1a </span> <input class='ke-img-margin' style='width:80px' value='5'/> px</label></p></div>";l.ATTRS={editor:{}};var o={"\u56fe\u7247\u5c5e\u6027":function(a){var b=a.getSelection();b=b&&b.getStartElement();b=m(b);a=a._toolbars.image;b&&a.show(null,b)}};i.extend(l,i.Base,{_init:function(){var a=this.get("editor"),b=a.toolBarDiv,g={};this.editor=a;this.el=new v({contentCls:"ke-toolbar-image",title:"\u63d2\u5165\u56fe\u7247",
container:b});this.el.on("offClick",this.show,this);t.on(a.document,"dblclick",this._dblclick,this);h.Utils.lazyRun(this,"_prepare","_real");a._toolbars=a._toolbars||{};a._toolbars.image=this;if(o)for(var c in o)(function(d){g[d]=function(){o[d](a)}})(c);h.ContextMenu.register(a.document,{rules:[m],width:"120px",funcs:g});r.attach({pluginName:"image",pluginInstance:this})},_dblclick:function(a){var b=new q(a.target);if(m(b)){this.show(null,b);a.halt()}},_prepare:function(){var a=this;a.get("editor");
a.d=new u({title:"\u56fe\u7247\u5c5e\u6027",mask:true,width:"350px"});var b=a.d;b.body.html(w);b.foot.html("<button class='ke-img-insert'>\u786e\u5b9a</button> <button class='ke-img-cancel'>\u53d6\u6d88</button>");a.content=b.el;b=a.content;var g=b.one(".ke-img-cancel"),c=b.one(".ke-img-insert");a.imgUrl=b.one(".ke-img-url");a.imgHeight=b.one(".ke-img-height");a.imgWidth=b.one(".ke-img-width");a.imgAlign=b.one(".ke-img-align");a.imgMargin=b.one(".ke-img-margin");g.on("click",function(d){a.d.hide();
d.halt()});c.on("click",function(){a._insert()})},_updateTip:function(a,b){a.html(b.attr("src"));a.attr("href",b.attr("src"))},_real:function(){this.d.show()},_insert:function(){var a=this.get("editor"),b=this.imgUrl.val();if(b){var g=parseInt(this.imgHeight.val()),c=parseInt(this.imgWidth.val()),d=this.imgAlign.val(),j=parseInt(this.imgMargin.val()),e="";if(g)e+="height:"+g+"px;";if(c)e+="width:"+c+"px;";if(d)e+="float:"+d;isNaN(j)||(e+="margin:"+j+"px;");if(e)e=" style='"+e+"' ";b=new q("<img "+
e+"src='"+b+"' alt='' />",null,a.document);b=a.insertElement(b,g||c?null:function(f){f.on("load",function(){f.detach();f.css({width:f.width()+"px",height:f.height()+"px"})})});this._selectedEl&&a.getSelection().selectElement(b);this.d.hide();a.notifySelectionChange()}},_updateD:function(a){if(this._selectedEl=a){this.imgUrl.val(a.attr("src"));this.imgHeight.val(a.height());this.imgWidth.val(a.width());this.imgAlign.val(a._4e_style("float"));this.imgMargin.val(parseInt(a._4e_style("margin"))||0)}else{this.imgUrl.val("http://");
this.imgHeight.val("\u81ea\u52a8");this.imgWidth.val("\u81ea\u52a8");this.imgAlign.val();this.imgMargin.val("5")}},show:function(a,b){this._prepare();this._updateD(b)}});h.ImageInserter=l;(function(a,b,g){r.register({pluginName:a,func:g,init:function(){var c=this,d=c.el;d.html(b+'  <a class="ke-bubbleview-url" target="_blank" href="#"></a> -     <span class="ke-bubbleview-link ke-bubbleview-change">\u7f16\u8f91</span> -     <span class="ke-bubbleview-link ke-bubbleview-remove">\u5220\u9664</span>');
var j=d.one(".ke-bubbleview-url"),e=d.one(".ke-bubbleview-change");d=d.one(".ke-bubbleview-remove");e._4e_unselectable();j._4e_unselectable();d._4e_unselectable();e.on("click",function(f){c._plugin.show(null,c._selectedEl);f.halt()});d.on("click",function(f){var k=c._plugin;if(s.webkit){var n=k.editor.getSelection().getRanges();n&&n[0]&&(n[0].collapse(true)||1)&&n[0].select()}c._selectedEl._4e_remove();c.hide();k.editor.notifySelectionChange();f.halt()});c.on("afterVisibleChange",function(f){var k=
c._selectedEl;f.newVal&&k&&c._plugin._updateTip(j,k)})}})})("image","\u56fe\u7247\u7f51\u5740\uff1a ",m)}();p.addPlugin(function(){new h.ImageInserter({editor:p})})});
